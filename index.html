<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>صالون بلال حمدي</title>
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #00ffff;
      --accent: #00ffff;
      --text: #fff;
      --bg-dark: #000010;
      --input-bg: rgba(255,255,255,0.06);
      --error: #ff1744;
      --success: #22d97a;
    }
    * {margin:0;padding:0;box-sizing:border-box;font-family:'Almarai',sans-serif;}
    html,body{height:100%;overflow-x:hidden;background:#000;}
    body{
      background: radial-gradient(circle at 30% 70%, rgba(0,255,255,0.25) 0%, transparent 50%),
                  radial-gradient(circle at 70% 30%, rgba(3,0,139,0.4) 0%, transparent 50%),
                  linear-gradient(135deg, #000010 0%, #03008a 60%, #000 100%);
      background-attachment: fixed;
      color:var(--text);
      min-height:100vh;
      padding:15px;
      padding-bottom:100px;
      position:relative;
      -webkit-font-smoothing:antialiased;
      user-select:none;
    }

    /* الشريط العلوي */
    .top-header{
      position:fixed;top:-100px;left:0;width:100%;
      background:rgba(0,0,0,0.6);backdrop-filter:blur(20px);
      border-bottom:1px solid rgba(0,255,255,0.4);
      padding:14px 16px;text-align:center;z-index:9999;
      box-shadow:0 4px 20px rgba(0,255,255,0.2);
      transition:top .7s cubic-bezier(.25,.8,.25,1);
    }
    .top-header.show{top:0;}
    .salon-name{font-size:1.4rem;font-weight:800;color:var(--primary);text-shadow:0 0 15px rgba(0,255,255,0.8);letter-spacing:1.2px;}
    .salon-slogan{font-size:0.8rem;color:#00ffff;opacity:0.95;font-weight:600;letter-spacing:2.5px;margin-top:5px;}

    /* الحاوية الرئيسية */
    .container{
      background:rgba(255,255,255,0.08);
      padding:30px 24px;
      border-radius:32px;
      border:2px solid rgba(0,255,255,0.4);
      box-shadow: inset 0 0 30px rgba(0,255,255,0.3),
                  0 0 40px rgba(0,255,255,0.25);
      max-width:460px;width:100%;margin:90px auto 140px auto;
      text-align:center;position:relative;
      backdrop-filter:blur(22px) saturate(180%);
      transition:margin .4s ease;
    }

    label{display:block;margin-bottom:8px;color:var(--accent);font-weight:700;text-align:right;font-size:1.02rem;}
    input,select{
      width:100%;padding:16px 18px;
      border:2px solid var(--primary);
      border-radius:18px;
      background:var(--input-bg);
      color:var(--accent);font-size:16px;
      transition:all .35s ease;margin-bottom:20px;
      appearance:none;
    }
    input::placeholder{color:rgba(0,255,255,0.55);}
    input:focus,select:focus{
      outline:none;border-color:#00ffff;
      box-shadow:0 0 25px rgba(0,255,255,0.5);
      transform:scale(1.03);
    }
    .error-message{color:var(--error);font-size:.9rem;margin-top:-14px;margin-bottom:16px;text-align:right;display:none;font-weight:700;}

    button[type=submit]{
      background:linear-gradient(135deg,#00ffff,#00b8d4);
      color:#000;font-size:1.2rem;font-weight:800;
      border:none;padding:17px 32px;border-radius:22px;
      cursor:pointer;width:100%;margin-top:28px;
      box-shadow:0 0 25px rgba(0,255,255,0.4);
      transition:all .35s ease;
    }
    button[type=submit]:hover{
      transform:scale(1.06);box-shadow:0 0 50px rgba(0,255,255,0.6);
    }

    /* الشريط السفلي */
    .bottom-nav{
      position:fixed;bottom:18px;left:50%;transform:translateX(-50%);
      width:92%;max-width:480px;
      background:rgba(255,255,255,0.08);backdrop-filter:blur(22px);
      border:1.5px solid rgba(0,255,255,0.35);
      border-radius:32px;padding:12px 0;
      display:flex;justify-content:space-around;z-index:100;
      box-shadow:0 -8px 35px rgba(0,0,0,0.5), 0 0 25px rgba(0,255,255,0.25);
      transition:all .4s ease;
    }
    .bottom-nav.hidden{transform:translateX(-50%) translateY(120%);opacity:0;pointer-events:none;}
    .nav-item{display:flex;flex-direction:column;align-items:center;color:var(--text);cursor:pointer;transition:all .3s ease;padding:10px 24px;border-radius:22px;}
    .nav-item.active{color:var(--primary);background:rgba(0,255,255,0.15);transform:scale(1.1);}
    .nav-icon{width:36px;height:36px;filter:drop-shadow(0 0 6px rgba(0,255,255,0.4));transition:all .3s ease;}
    .nav-item.active .nav-icon{filter:drop-shadow(0 0 15px rgba(0,255,255,0.9));transform:scale(1.25);}

    /* باقي العناصر */
    .screen{display:none;width:100%;min-height:calc(100vh - 100px);padding:20px;padding-top:90px;padding-bottom:0;}
    .screen.active{display:flex;flex-direction:column;align-items:center;}
    .success-toast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0.8);
      background:linear-gradient(135deg,#00ffff,#00b8d4);color:#000;
      padding:22px 32px;border-radius:20px;box-shadow:0 0 50px rgba(0,255,255,0.6);
      z-index:10000;font-weight:800;font-size:1.15rem;opacity:0;pointer-events:none;transition:all .4s ease;}
    .success-toast.show{opacity:1;transform:translate(-50%,-50%) scale(1);}
    
    /* بطاقة الحجز - مُحسّنة */
    .details-card{
      background:rgba(255,255,255,0.08);
      border:2px solid var(--primary);
      border-radius:18px;
      padding:26px 22px;
      margin-top:20px;
      box-shadow:0 0 25px rgba(0,255,255,0.25);
      text-align:right;
      word-wrap:break-word;
      overflow-wrap:break-word;
    }
    .details-card h3{
      color:var(--primary);
      margin-bottom:18px;
      font-size:1.35rem;
      text-align:center;
    }
    .details-card p{
      margin:12px 0;
      line-height:1.6;
      font-size:1.05rem;
    }
    .details-card b{color:var(--accent);}

    /* رقم الموبايل - الحل السحري */
    .phone-display{
      direction:ltr;
      text-align:center;
      font-weight:700;
      font-size:1.2rem;
      color:var(--accent);
      margin:14px 0;
      padding:12px 16px;
      background:rgba(0,255,255,0.12);
      border-radius:12px;
      border:1.5px solid var(--accent);
      word-break:break-all; /* يكسر الرقم لو طويل جدًا */
      overflow:hidden;
      line-height:1.4;
    }

    .booking-status{
      color:var(--success);
      font-weight:700;
      padding:10px 16px;
      background:rgba(34,217,122,0.15);
      border-radius:10px;
      border:1px solid var(--success);
      text-align:center;
      margin:14px 0;
    }
    .cancel-btn{
      background:#ff1744;
      color:white;
      padding:13px 32px;
      border:none;
      border-radius:12px;
      cursor:pointer;
      margin-top:20px;
      font-weight:700;
      font-size:1.05rem;
      width:100%;
    }
    .cancel-btn:hover{background:#d50032;}

    .active-booking-banner{
      background:rgba(0,255,255,0.12);
      border:1.5px solid var(--primary);
      border-radius:14px;
      padding:16px;
      margin:20px 0;
      text-align:center;
      color:var(--primary);
      font-weight:700;
      cursor:pointer;
      font-size:1.1rem;
    }
    .no-bookings{
      text-align:center;
      color:#aaa;
      margin-top:60px;
      font-size:1.2rem;
    }
    .confirmation-modal{
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.8);
      display:none;justify-content:center;align-items:center;z-index:10000;
    }
    .confirmation-content{
      background:rgba(255,255,255,0.08);
      padding:30px;
      border-radius:20px;
      border:2px solid rgba(0,255,255,0.4);
      box-shadow:0 0 40px rgba(0,255,255,0.5);
      text-align:center;
      max-width:340px;
      width:90%;
    }
    .confirm-yes,.confirm-no{
      padding:14px;
      border:none;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
      margin:8px;
      flex:1;
      font-size:1.05rem;
    }
    .confirm-yes{background:linear-gradient(135deg,#22d97a,#00ffff);color:white;}
    .confirm-no{background:#ff1744;color:white;}
  </style>
</head>
<body>

  <!-- الشريط العلوي -->
  <div class="top-header">
    <div class="salon-name">صالون بلال حمدي</div>
    <div class="salon-slogan">احجز موعدك بسهولة وسرعة</div>
  </div>

  <!-- شاشة الحجز -->
  <div id="mainScreen" class="screen active">
    <div class="container">
      <form id="bookingForm">
        <label for="name">الاسم كامل</label>
        <input type="text" id="name" required placeholder="أدخل الاسم">

        <label for="phone">رقم الموبايل</label>
        <input type="tel" id="phone" required placeholder="01xxxxxxxxx">
        <div class="error-message" id="phoneError">رقم الجوال لازم 11 رقم</div>

        <label for="day">اختر اليوم</label>
        <select id="day" required></select>

        <label for="slot">اختر الوقت</label>
        <select id="slot" required></select>

        <button type="submit">احجز الآن</button>
      </form>
    </div>
  </div>

  <!-- شاشة الحجوزات -->
  <div id="bookingsScreen" class="screen">
    <div class="container">
      <h2 style="color:var(--primary);font-size:1.9rem;margin-bottom:20px;">الحجز</h2>
      <div id="activeBookingBanner" class="active-booking-banner hidden">لديك حجز نشط</div>
      <div id="bookingsList"></div>
      <div id="noBookingsMessage" class="no-bookings hidden"></div>
    </div>
  </div>

  <!-- الشريط السفلي -->
  <div class="bottom-nav" id="bottomNav">
    <div class="nav-item active" id="navHome">
      <img src="home-button.png" class="nav-icon" alt="الرئيسية">
    </div>
    <div class="nav-item" id="navBookings">
      <img src="order-history.png" class="nav-icon" alt="الحجوزات">
    </div>
  </div>

  <!-- نافذة التأكيد -->
  <div id="confirmationModal" class="confirmation-modal">
    <div class="confirmation-content">
      <h3 style="color:var(--primary);margin-bottom:15px;">تأكيد الإلغاء</h3>
      <p style="margin-bottom:20px;">متأكد إنك عايز تلغي الحجز ده؟</p>
      <div style="display:flex;gap:12px;">
        <button class="confirm-yes" id="confirmYes">أيوة</button>
        <button class="confirm-no" id="confirmNo">لأ</button>
      </div>
    </div>
  </div>

  <div id="successToast" class="success-toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyALYto6lJvO0qrne3mL1zz2jBdlgnA4-nA",
      authDomain: "salonbookingsystem-d2296.firebaseapp.com",
      databaseURL: "https://salonbookingsystem-d2296-default-rtdb.firebaseio.com",
      projectId: "salonbookingsystem-d2296",
      storageBucket: "salonbookingsystem-d2296.firebasestorage.app",
      messagingSenderId: "51763851442",
      appId: "1:51763851442:web:3ebd2e1c6d84a24ac119ab"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const mainScreen = document.getElementById("mainScreen");
    const bookingsScreen = document.getElementById("bookingsScreen");
    const navHome = document.getElementById("navHome");
    const navBookings = document.getElementById("navBookings");
    const bottomNav = document.getElementById("bottomNav");
    const bookingsList = document.getElementById("bookingsList");
    const noBookingsMessage = document.getElementById("noBookingsMessage");
    const activeBookingBanner = document.getElementById("activeBookingBanner");
    const confirmationModal = document.getElementById("confirmationModal");
    const confirmYes = document.getElementById("confirmYes");
    const confirmNo = document.getElementById("confirmNo");
    const toast = document.getElementById("successToast");
    const form = document.getElementById("bookingForm");
    const nameInput = document.getElementById("name");
    const phoneInput = document.getElementById("phone");
    const phoneError = document.getElementById("phoneError");
    const daysSelect = document.getElementById("day");
    const slotSelect = document.getElementById("slot");

    const daysArabic = ["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"];
    let currentUser = JSON.parse(localStorage.getItem("currentUser")) || null;
    let myBooking = JSON.parse(localStorage.getItem("myBooking")) || null;
    let bookingToCancel = null;
    let currentBookings = {};

    function formatTime12(h, m) {
      const hour = h % 12 || 12;
      const minute = m.toString().padStart(2, '0');
      const period = h >= 12 ? 'م' : 'ص';
      return `${hour}:${minute} ${period}`;
    }

    function isValidName(n) { return /^[\u0600-\u06FF\s]{7,50}$/.test(n.trim()); }
    function isValidPhone(p) { return /^01[0125][0-9]{8}$/.test(p); }

    nameInput.addEventListener("keydown", e => { if (/[0-9]/.test(e.key)) e.preventDefault(); });
    phoneInput.addEventListener("input", () => {
      const v = phoneInput.value;
      if (v && !isValidPhone(v)) {
        phoneInput.style.borderColor = "#ff1744";
        phoneError.style.display = "block";
      } else {
        phoneInput.style.borderColor = "#00ffff";
        phoneError.style.display = "none";
      }
    });

    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3200);
    }

    function showMainScreen() {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      mainScreen.classList.add('active');
      document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      navHome.classList.add('active');
      populateDays();
    }

    function showBookingsScreen() {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      bookingsScreen.classList.add('active');
      document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      navBookings.classList.add('active');
      loadUserBookings();
      activeBookingBanner.classList.toggle("hidden", !myBooking);
      if (myBooking) activeBookingBanner.onclick = () => showBookingInList(myBooking);
    }

    navHome.onclick = showMainScreen;
    navBookings.onclick = showBookingsScreen;

    function populateDays() {
      daysSelect.innerHTML = "<option value=''>اختر اليوم</option>";
      const today = new Date();
      let added = 0, i = 0;
      while (added < 7 && i < 30) {
        const d = new Date();
        d.setDate(today.getDate() + i++);
        const dayOfWeek = d.getDay();
        if (dayOfWeek === 1) continue;
        const val = d.toISOString().slice(0, 10);
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = `${daysArabic[dayOfWeek]} (${d.getDate()}/${d.getMonth() + 1})`;
        daysSelect.appendChild(opt);
        added++;
      }
      populateSlots();
    }

    function populateSlots() {
      slotSelect.innerHTML = "<option value=''>اختر الوقت</option>";
      const slots = [];
      for (let h = 15; h <= 23; h++) { slots.push({h,m:0}); slots.push({h,m:20}); slots.push({h,m:40}); }
      for (let h = 0; h <= 2; h++) { slots.push({h,m:0}); if (h < 2) slots.push({h,m:20}); if (h < 2) slots.push({h,m:40}); }
      slots.forEach(s => {
        const t = `${s.h.toString().padStart(2,'0')}:${s.m.toString().padStart(2,'0')}`;
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = formatTime12(s.h, s.m);
        slotSelect.appendChild(opt);
      });
      updateSlots();
    }

    const bookingsRef = ref(db, "bookings");
    onValue(bookingsRef, snap => {
      currentBookings = snap.val() || {};
      updateSlots();
      if (myBooking && !currentBookings[myBooking.slotKey]) {
        showToast("تم إلغاء حجزك من الصالون");
        localStorage.removeItem("myBooking");
        myBooking = null;
        activeBookingBanner.classList.add("hidden");
      }
    });

    function updateSlots() {
      if (!daysSelect.value) return;
      const now = new Date();
      const today = now.toISOString().slice(0,10);
      slotSelect.querySelectorAll("option").forEach(opt => {
        if (!opt.value) return;
        const key = `${daysSelect.value}_${opt.value}`;
        const [h,m] = opt.value.split(":").map(Number);
        const slotTime = new Date(daysSelect.value);
        slotTime.setHours(h, m, 0, 0);
        const isPast = daysSelect.value === today && slotTime < now;
        const booked = currentBookings[key] ? Object.keys(currentBookings[key]).length : 0;
        opt.disabled = isPast || booked >= 2;
        opt.style.opacity = opt.disabled ? "0.4" : "1";
        opt.textContent = opt.disabled 
          ? `${formatTime12(h,m)} ${isPast ? '(انتهى)' : '(مكتمل)'}` 
          : formatTime12(h,m);
      });
    }

    daysSelect.onchange = () => { populateSlots(); };

    form.onsubmit = async e => {
      e.preventDefault();
      const name = nameInput.value.trim();
      const phone = phoneInput.value.trim();
      const day = daysSelect.value;
      const time = slotSelect.value;

      if (!isValidName(name)) return showToast("الاسم لازم يكون عربي وأكثر من 6 حروف");
      if (!isValidPhone(phone)) return showToast("رقم الموبايل لازم يبدأ بـ 01 و11 رقم");
      if (!day || !time) return showToast("اختار اليوم والوقت");

      const slotKey = `${day}_${time}`;
      const booked = currentBookings[slotKey] ? Object.keys(currentBookings[slotKey]).length : 0;
      if (booked >= 2) return showToast("الفترة دي مكتملة");

      const bookingId = Date.now().toString();
      currentUser = { name, phone, userId: Date.now().toString() };
      localStorage.setItem("currentUser", JSON.stringify(currentUser));

      await set(ref(db, `bookings/${slotKey}/${bookingId}`), {
        name, phone, day, time,
        timestamp: new Date().toISOString(),
        userId: currentUser.userId
      });

      myBooking = { name, phone, day, time, slotKey, bookingId };
      localStorage.setItem("myBooking", JSON.stringify(myBooking));
      showToast("تم الحجز بنجاح!");
      form.reset();
      setTimeout(showBookingsScreen, 1800);
    };

    function showBookingInList(b) {
      const d = new Date(b.day);
      const [h,m] = b.time.split(":").map(Number);
      const html = `
        <div class="details-card" data-bid="${b.bookingId}">
          <h3>تفاصيل الحجز</h3>
          <p><b>الاسم:</b> ${b.name}</p>
          <div class="phone-display">${b.phone}</div>
          <p><b>اليوم:</b> ${daysArabic[d.getDay()]} (${d.getDate()}/${d.getMonth()+1})</p>
          <p><b>الوقت:</b> ${formatTime12(h,m)}</p>
          <div class="booking-status">موعد قادم</div>
          <button class="cancel-btn">إلغاء الحجز</button>
        </div>`;
      if (!document.querySelector(`[data-bid="${b.bookingId}"]`)) {
        const div = document.createElement("div");
        div.innerHTML = html;
        div.querySelector('.cancel-btn').onclick = () => showCancelConfirmation(b);
        bookingsList.prepend(div);
      }
    }

    function showCancelConfirmation(b) {
      bookingToCancel = b;
      confirmationModal.style.display = "flex";
    }

    confirmYes.onclick = async () => {
      if (!bookingToCancel) return;
      await remove(ref(db, `bookings/${bookingToCancel.slotKey}/${bookingToCancel.bookingId}`));
      if (myBooking && myBooking.bookingId === bookingToCancel.bookingId) {
        localStorage.removeItem("myBooking");
        myBooking = null;
        activeBookingBanner.classList.add("hidden");
      }
      showToast("تم إلغاء الحجز");
      confirmationModal.style.display = "none";
      loadUserBookings();
    };

    confirmNo.onclick = () => confirmationModal.style.display = "none";

    function loadUserBookings() {
      bookingsList.innerHTML = "";
      if (!currentUser) { noBookingsMessage.classList.remove("hidden"); return; }
      const userBookings = [];
      for (const slotKey in currentBookings) {
        for (const bid in currentBookings[slotKey]) {
          const b = currentBookings[slotKey][bid];
          if (b.userId === currentUser.userId) {
            const [day,time] = slotKey.split("_");
            userBookings.push({ ...b, slotKey, bookingId: bid, day, time });
          }
        }
      }
      if (userBookings.length === 0) {
        noBookingsMessage.classList.remove("hidden");
        return;
      }
      noBookingsMessage.classList.add("hidden");
      userBookings.sort((a,b) => a.day.localeCompare(b.day));
      userBookings.forEach(showBookingInList);
    }

    document.querySelectorAll("input, select").forEach(el => {
      el.addEventListener("focus", () => {
        bottomNav.classList.add("hidden");
        document.querySelector(".container").style.marginBottom = "30px";
      });
      el.addEventListener("blur", () => {
        setTimeout(() => {
          if (!document.activeElement?.matches("input, select")) {
            bottomNav.classList.remove("hidden");
            document.querySelector(".container").style.marginBottom = "140px";
          }
        }, 150);
      });
    });

    setTimeout(() => document.querySelector('.top-header').classList.add('show'), 500);
    setTimeout(() => document.querySelector('.top-header').classList.remove('show'), 3500);

    populateDays();
    if (myBooking) setTimeout(() => activeBookingBanner.classList.remove("hidden"), 800);
  </script>
</body>
</html>


